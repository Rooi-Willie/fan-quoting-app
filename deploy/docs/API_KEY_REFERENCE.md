# ğŸ” Quick Reference: API Keys & Credentials

## TL;DR - Your Questions Answered

### Q1: "Does 1_setup_gcp.py create an API key I need to copy?"

**YES!** Here's exactly what happens:

1. **Run deployment script:**
   ```bash
   python deploy/scripts/_setup_gcp.py
   ```

2. **Script generates a secure API key** like:
   ```
   abf_xK9mP2wQ7nF4jL8sY3vR5tU1oI6eA2dH4gJ9mN7pQ3sW
   ```

3. **Key is saved to** `deploy/config.yaml`:
   ```yaml
   api:
     api_key: "abf_xK9mP2wQ7nF4jL8sY3vR5tU1oI6eA2dH4gJ9mN7pQ3sW"
   ```

4. **Later, when you run** `python deploy/scripts/_deploy_ui.py`, it shows:
   ```
   ========================================
   COPY THIS TO STREAMLIT CLOUD:
   ========================================
   
   API_KEY = "abf_xK9mP2wQ7nF4jL8sY3vR5tU1oI6eA2dH4gJ9mN7pQ3sW"
   ```

5. **You manually copy-paste** this into Streamlit Cloud's Secrets dashboard

**Why manual?** Streamlit Cloud has no API for programmatic secret management - you must paste it manually for security.

---

### Q2: "How do development and production credentials differ?"

## Visual Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEVELOPMENT (Local)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Files on your computer:
â”œâ”€â”€ .env                           â† Docker Compose reads this
â”‚   â”œâ”€â”€ POSTGRES_USER=devuser
â”‚   â”œâ”€â”€ POSTGRES_PASSWORD=devpassword
â”‚   â””â”€â”€ API_KEY=dev-local-key-12345
â”‚
â””â”€â”€ ui/.streamlit/secrets.toml     â† Streamlit reads this
    â”œâ”€â”€ API_BASE_URL=http://api:8080
    â””â”€â”€ API_KEY=dev-local-key-12345

Flow:
Docker Compose â†’ reads .env â†’ passes to containers
Streamlit UI â†’ reads secrets.toml â†’ sends API requests with key
API â†’ reads .env â†’ validates key â†’ connects to database


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRODUCTION (Cloud)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

deploy/config.yaml (on your computer):
â”œâ”€â”€ app_password: "Xm9$kP2#wQ7nF4@jL8s"  â† You create
â”œâ”€â”€ root_password: "Zn8!pR5%tU1oI6$eA2"  â† You create
â””â”€â”€ api_key: "abf_xK9mP2wQ7nF4j..."     â† Script generates

GCP Secret Manager (in Google Cloud):
â”œâ”€â”€ API_KEY â†’ "abf_xK9mP2wQ7nF4j..."
â”œâ”€â”€ DB_PASSWORD â†’ "Xm9$kP2#wQ7nF4@jL8s"
â””â”€â”€ DB_ROOT_PASSWORD â†’ "Zn8!pR5%tU1oI6$eA2"

Streamlit Cloud Secrets (you paste manually):
â”œâ”€â”€ API_BASE_URL â†’ "https://...run.app"
â””â”€â”€ API_KEY â†’ "abf_xK9mP2wQ7nF4j..."

Flow:
Streamlit UI â†’ reads Streamlit Secrets â†’ sends API requests
Cloud Run API â†’ reads GCP Secrets â†’ validates key â†’ connects to database
```

---

## Credential Lifecycle

### ğŸ  Development Credentials (Simple)

**When:** Local testing only  
**Security:** Basic (file-based)  
**Created:** By you, manually

| Credential | Value | Where Stored | Who Uses It |
|-----------|-------|--------------|-------------|
| Database User | `devuser` | `.env` | API â†’ Database |
| Database Password | `devpassword` | `.env` | API â†’ Database |
| API Key | `dev-local-key-12345` | `.env` + `secrets.toml` | UI â†’ API |
| API URL | `http://api:8080` | `secrets.toml` | UI â†’ API |

**Purpose:** Quick setup, easy debugging, no cost

---

### â˜ï¸ Production Credentials (Secure)

**When:** Public deployment  
**Security:** Advanced (Secret Manager, IAM)  
**Created:** By deployment scripts + you

| Credential | Example Value | How Created | Where Stored | Who Uses It |
|-----------|--------------|-------------|--------------|-------------|
| Database User | `app_user` | You set in `config.yaml` | GCP Secret Manager | Cloud Run â†’ Cloud SQL |
| Database Password | `Xm9$kP2#wQ...` | You set in `config.yaml` | GCP Secret Manager | Cloud Run â†’ Cloud SQL |
| API Key | `abf_xK9mP2w...` | Generated by `1_setup_gcp.py` | GCP Secret Manager + Streamlit Secrets | Streamlit â†’ Cloud Run |
| API URL | `https://...run.app` | Generated by Cloud Run | Streamlit Secrets | Streamlit â†’ Cloud Run |

**Purpose:** Security, compliance, auditability

---

## The Complete Flow: Development

### Step 1: You Create Files

```bash
# Create .env
POSTGRES_DB=quoting_db
POSTGRES_USER=devuser
POSTGRES_PASSWORD=devpassword
API_KEY=dev-local-key-12345

# Create ui/.streamlit/secrets.toml
API_BASE_URL = "http://api:8080"
API_KEY = "dev-local-key-12345"
```

### Step 2: Docker Reads .env

```bash
docker-compose up -d

# Docker creates:
- Database with user: devuser, password: devpassword
- API with API_KEY environment variable: dev-local-key-12345
```

### Step 3: Application Uses Credentials

```
User opens http://localhost:8501
    â†“
Streamlit reads secrets.toml
    â†“
Sends request to http://api:8080 with header X-API-Key: dev-local-key-12345
    â†“
API reads API_KEY from environment (from .env)
    â†“
Validates: dev-local-key-12345 == dev-local-key-12345 âœ“
    â†“
API reads database credentials from environment (from .env)
    â†“
Connects to PostgreSQL with devuser:devpassword@db:5432/quoting_db âœ“
```

---

## The Complete Flow: Production

### Step 1: You Prepare config.yaml

```yaml
database:
  credentials:
    app_password: "MyStr0ng!Pass#2024"  # â† You create
    root_password: "Adm1n$ecure!2024"   # â† You create

api:
  api_key: ""  # â† Empty (will be generated)
```

### Step 2: Run Deployment Scripts

#### 1_setup_gcp.py
```bash
python deploy/scripts/_setup_gcp.py

# Generates:
api_key: "abf_xK9mP2wQ7nF4jL8sY3vR5tU1oI6eA2dH4gJ9mN7pQ3sW"

# Saves to config.yaml
```

#### 2_init_database.py
```bash
python deploy/scripts/_init_database.py

# Creates Cloud SQL instance
# Stores in Secret Manager:
- DB_PASSWORD â†’ "MyStr0ng!Pass#2024"
- DB_ROOT_PASSWORD â†’ "Adm1n$ecure!2024"
```

#### 3_deploy_api.py
```bash
python deploy/scripts/_deploy_api.py

# Stores in Secret Manager:
- API_KEY â†’ "abf_xK9mP2wQ7nF4jL8sY3vR5tU1oI6eA2dH4gJ9mN7pQ3sW"

# Configures Cloud Run with environment:
- DB_USER=app_user
- DB_PASSWORD â†’ references Secret Manager
- API_KEY â†’ references Secret Manager
- CLOUD_SQL_CONNECTION_NAME=abf-fan-quoting-app:us-central1:fan-quoting-db

# Deploys and returns:
API URL: https://fan-quoting-api-xyz123-uc.a.run.app
```

#### 4_deploy_ui.py
```bash
python deploy/scripts/_deploy_ui.py

# Shows you to copy:
=================================
PASTE INTO STREAMLIT CLOUD:
=================================

API_BASE_URL = "https://fan-quoting-api-xyz123-uc.a.run.app"
API_KEY = "abf_xK9mP2wQ7nF4jL8sY3vR5tU1oI6eA2dH4gJ9mN7pQ3sW"
```

### Step 3: You Manually Configure Streamlit

1. Go to https://share.streamlit.io
2. Click your app â†’ Settings â†’ Secrets
3. Paste:
   ```toml
   API_BASE_URL = "https://fan-quoting-api-xyz123-uc.a.run.app"
   API_KEY = "abf_xK9mP2wQ7nF4jL8sY3vR5tU1oI6eA2dH4gJ9mN7pQ3sW"
   ```
4. Save

### Step 4: Application Uses Credentials

```
User visits https://your-app.streamlit.app
    â†“
Streamlit reads Streamlit Cloud Secrets
    â†“
Sends request to https://...run.app with X-API-Key: abf_xK9m...
    â†“
Cloud Run reads API_KEY from Secret Manager
    â†“
Validates: abf_xK9m... == abf_xK9m... âœ“
    â†“
Cloud Run reads DB_PASSWORD from Secret Manager
    â†“
Connects to Cloud SQL via Unix socket with app_user:MyStr0ng!Pass#2024 âœ“
```

---

## Key Differences Summarized

| Aspect | Development | Production |
|--------|-------------|------------|
| **Where You Store Secrets** | Files (`.env`, `secrets.toml`) | GCP Secret Manager + Streamlit Dashboard |
| **API Key Complexity** | Simple (`dev-local-key-12345`) | Secure 48-char random (`abf_xK9m...`) |
| **API Key Creation** | You type it | Script generates it |
| **Database Password** | Simple (`devpassword`) | Complex (`MyStr0ng!Pass#2024`) |
| **Password Storage** | Plain text in `.env` | Encrypted in Secret Manager |
| **Database Connection** | TCP to localhost:5433 | Unix socket to Cloud SQL |
| **API URL** | `http://api:8080` | `https://...run.app` |
| **Cost** | Free (local) | ~$20/month |
| **Setup Time** | 5 minutes | 1-2 hours (first time) |
| **Security Level** | Basic | Production-grade |
| **Who Can Access** | Only you (localhost) | Anyone with email auth |

---

## Common Confusion Points Explained

### "Why do I need to copy the API key manually?"

**Technical reason:** Streamlit Cloud doesn't provide an API to programmatically set secrets.

**Security reason:** You explicitly see what credentials are being deployed. No automated script can accidentally leak credentials.

**Best practice:** Manual review step ensures you're aware of what's being configured.

---

### "Why different passwords for dev and prod?"

**Development:** Simple passwords make debugging easier. If database gets corrupted, you just delete the Docker volume.

**Production:** Complex passwords protect against:
- Brute force attacks
- Dictionary attacks  
- Credential stuffing
- Data breaches

If your production database gets compromised with simple passwords, attackers can access customer data.

---

### "Why is the API key stored in two places in production?"

```
GCP Secret Manager
â””â”€â”€ API_KEY="abf_xK9m..."  â† Cloud Run (API) reads from here

Streamlit Cloud Secrets
â””â”€â”€ API_KEY="abf_xK9m..."  â† Streamlit (UI) reads from here
```

**Why not one place?** Because they're on different cloud platforms:
- GCP Secret Manager is Google's system
- Streamlit Cloud Secrets is Streamlit's system
- They don't talk to each other

Both need the same key so UI can authenticate with API.

---

### "What if I lose the API key?"

**Development:** Just change it in `.env` and `secrets.toml`, restart Docker.

**Production:** 
1. Generate new key: `python deploy/scripts/_setup_gcp.py` (it will ask if you want to regenerate)
2. Update GCP Secret Manager: `python deploy/scripts/_deploy_api.py` (redeploy)
3. Update Streamlit Cloud: Paste new key in dashboard
4. Old key stops working immediately

---

## Troubleshooting Checklist

### âœ… Development Working Correctly

```bash
# 1. Check .env has the key
cat .env | grep API_KEY
# Should show: API_KEY=dev-local-key-12345

# 2. Check secrets.toml has the key
cat ui/.streamlit/secrets.toml | grep API_KEY
# Should show: API_KEY = "dev-local-key-12345"

# 3. Check they match
# .env:           API_KEY=dev-local-key-12345
# secrets.toml:   API_KEY = "dev-local-key-12345"
# âœ“ They match!

# 4. Restart Docker
docker-compose down
docker-compose up -d

# 5. Test
curl -H "X-API-Key: dev-local-key-12345" http://localhost:8080/health
# Should return: {"status":"healthy"}
```

---

## Next Steps

### If You're Still in Development

âœ… Your setup is complete! Continue building features locally.

### When Ready to Deploy

1. Read `deploy/docs/DEPLOYMENT_GUIDE.md`
2. Edit `deploy/config.yaml` (set strong passwords)
3. Follow deployment steps 1-4
4. Remember to copy the API key when script shows it

---

## Quick Commands

```bash
# Development: Restart everything
docker-compose down && docker-compose up -d

# Development: Check API logs
docker logs quoting_api_dev

# Development: Check DB logs  
docker logs quoting_db_dev

# Development: Test API
curl -H "X-API-Key: dev-local-key-12345" http://localhost:8080/health

# Production: View API key in config
cat deploy/config.yaml | grep api_key

# Production: Test deployed API
curl -H "X-API-Key: abf_YOUR_KEY" https://your-api.run.app/health
```
